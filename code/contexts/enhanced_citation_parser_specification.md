# AI理解支援引用文献パーサー機能仕様書 v4.0

## 概要
ObsClippingsManager v4.0における引用文献パース機能の革新的強化版です。**AIアシスタント（ChatGPT、Claude等）が引用文献を完全に理解し、適切な引用付き論文を執筆できるよう支援する**ことを主目的とします。

従来の引用形式統一に加え、**AI用統合ファイル生成機能**を新たに追加し、人間がAIに論文執筆を依頼する際の課題を解決します。

## 背景と解決すべき課題

### 現在の問題
```
ユーザー → AI：「この論文のIntroductionをまとめて」

AI：「[1],[2],[3]という引用がありますが、これが何の文献なのか分からないため、
     適切な引用付きの文章を作成できません」
```

### 目標：AIが完全理解できる統合ファイル生成
```
ObsClippingsManager処理後:

## 📚 Citation Reference Table
[1] → Smith, J. et al. (2023). "Novel Method for Cancer Analysis". Cancer Research, 83(12), 1234-1245.
[2] → Jones, M. & Wilson, K. (2022). "Advanced Biomarker Techniques". Nature Medicine, 28, 567-578.
[3] → Brown, A. (2021). "Differential Diagnosis in Oncology". Cell, 185, 890-905.

## 📄 Paper Content
Aberrant expression in various cancers makes KRTs useful as biomarkers [1],[2],[3].

AI：「[1]はSmith et al.のがん解析手法の論文、[2]はJonesのバイオマーカー技術論文、
     [3]はBrownの診断学論文ですね。これらを踏まえて適切な論文を執筆します」
```

## 主要機能

### 1. 軽量引用マッピング機能
- YAMLヘッダーに最小限のマッピング情報を追加
- references.bibとの動的連携
- データ重複を避けたシンプル設計

### 2. AI用統合ファイル生成機能（新機能）
- 引用文献情報を完全に統合したAI理解用ファイル生成
- Citation Reference Table + Paper Content形式
- AIが即座に引用文献を理解可能

### 3. 引用形式統一機能（従来機能強化）
- 多様な引用形式の検出・統一
- エスケープパターン対応
- URL付き引用のクリーンアップ

## 機能詳細仕様

### 1. 軽量引用マッピング機能

#### YAMLヘッダー拡張
```yaml
---
title: "論文タイトル"
doi: "10.1093/jrr/rrac091"
# 新機能：軽量引用マッピング
citation_mapping:
  references_file: "./references.bib"           # 対応するreferences.bibファイル
  index_map:                                    # 引用番号 → citation_key マッピング
    1: "smith2023test"                          # [1] → citation_key
    2: "jones2022study"                         # [2] → citation_key  
    3: "brown2021method"                        # [3] → citation_key
  last_updated: "2024-01-15T10:30:00"          # マッピング最終更新時刻
  mapping_version: "1.0"                       # マッピングバージョン
---
```

#### 実装クラス
```python
class CitationMappingEngine:
    """軽量引用マッピング作成エンジン"""
    
    def create_citation_mapping(self, markdown_file: str, references_bib: str) -> CitationMapping:
        """
        引用番号とcitation_keyの軽量マッピングを作成
        
        Process:
        1. Markdownファイル内の引用番号を検出
        2. references.bibからcitation_keyを抽出
        3. 引用順序に基づいてマッピング作成
        4. YAMLヘッダーに軽量マッピング情報を追加
        
        Returns:
            CitationMapping: マッピング情報オブジェクト
        """
        
    def update_yaml_header(self, markdown_file: str, citation_mapping: CitationMapping) -> bool:
        """
        YAMLヘッダーにマッピング情報を追加・更新
        
        Args:
            markdown_file: 対象Markdownファイル
            citation_mapping: 作成されたマッピング情報
            
        Returns:
            成功フラグ
        """
```

### 2. AI用統合ファイル生成機能（核心機能）

#### 生成される統合ファイル形式
```markdown
# 論文タイトル
*Generated by ObsClippingsManager v4.0 for AI Assistant*

## 📚 Citation Reference Table
**AI Assistant Reference Guide: This table provides complete citation information for all numbered references in the paper.**

[1] → **Smith, J., Wilson, K., & Davis, M.** (2023). *Novel Method for Cancer Cell Analysis*. **Cancer Research**, 83(12), 1234-1245. DOI: 10.1158/0008-5472.CAN-23-0123
    └─ **Context**: This paper introduces innovative methodologies for analyzing cancer cell behavior.

[2] → **Jones, M. & Brown, A.** (2022). *Advanced Biomarker Techniques in Oncology*. **Nature Medicine**, 28, 567-578. DOI: 10.1038/s41591-022-0456-7
    └─ **Context**: Comprehensive review of current biomarker applications in cancer diagnosis.

[3] → **Brown, A., Lee, S., & Kumar, R.** (2021). *Differential Diagnosis Methods in Modern Oncology*. **Cell**, 185, 890-905. DOI: 10.1016/j.cell.2021.03.012
    └─ **Context**: Systematic approach to differential diagnosis using molecular markers.

---

## 📄 Paper Content

### Introduction
Aberrant expression in various cancers makes KRTs useful as biomarkers for differential diagnoses and metastatic status. Recent studies suggest that KRTs in cancer cells are not only epithelial marker proteins but are also mediators capable of interacting with a range of proteins to regulate signaling networks associated with cell death, survival, proliferation, migration, invasion and metastasis [1],[2],[3].

The established framework [2] provides a foundation for understanding biomarker applications, while novel analytical methods [1] offer new insights into cancer cell behavior. Previous comprehensive studies [3] have demonstrated the importance of systematic diagnostic approaches.

---
*End of AI Assistant Document*
*Original file: paper.md | References: references.bib | Generated: 2024-01-15 10:30:00*
```

#### 実装クラス
```python
class AIAssistantFileGenerator:
    """AI理解支援用統合ファイル生成器"""
    
    def generate_ai_readable_file(self, markdown_file: str, references_bib: str, 
                                 output_file: str = None) -> str:
        """
        AIが完全に理解できる統合ファイルを生成
        
        Args:
            markdown_file: 元のMarkdownファイル
            references_bib: 対応するreferences.bibファイル
            output_file: 出力ファイル名（未指定時は自動生成）
            
        Returns:
            生成されたファイルパス
            
        Process:
        1. YAMLヘッダーからcitation_mappingを読み込み
        2. references.bibから詳細情報を取得
        3. Citation Reference Tableを生成
        4. 元のPaper Contentと統合
        5. AI理解最適化フォーマットで出力
        """
        
    def create_citation_reference_table(self, citation_mapping: CitationMapping, 
                                       bibtex_entries: Dict[str, BibTeXEntry]) -> str:
        """
        AI理解用Citation Reference Tableを生成
        
        Format:
        [番号] → **著者** (年). *タイトル*. **ジャーナル**, 巻(号), ページ. DOI: xxx
            └─ **Context**: 論文の概要説明
        """
        
    def enhance_paper_content(self, content: str, citation_mapping: CitationMapping) -> str:
        """
        論文内容にAI理解支援コメントを追加
        """
```

### 3. 動的引用解決機能

#### リアルタイム情報取得
```python
class CitationResolver:
    """引用番号からリアルタイムでBibTeX情報を取得"""
    
    def resolve_citation(self, citation_number: int, markdown_file: str) -> CitationInfo:
        """
        引用番号から完全な文献情報を動的に取得
        
        Process:
        1. YAMLヘッダーからcitation_keyを取得
        2. references.bibから詳細情報を取得
        3. 文脈情報を抽出
        4. 統合したCitationInfoを返す
        
        Returns:
            CitationInfo: 完全な引用文献情報
        """
        
    def batch_resolve_citations(self, citation_numbers: List[int], 
                               markdown_file: str) -> Dict[int, CitationInfo]:
        """
        複数の引用番号を一括解決
        """
        
    def extract_citation_context(self, markdown_file: str, citation_number: int) -> str:
        """
        引用箇所周辺の文脈を抽出してAI理解を支援
        """
```

### 4. 引用形式統一機能（従来機能継承）

#### 対応パターン
```python
CITATION_PATTERNS = {
    # エスケープ形式
    'escaped_basic': r'\\?\[\[(\d+)\]\]',                    # \[[1]\]
    'escaped_multiple': r'\\?\[\[(\d+(?:[,\s]*\d+)*)\]\]',   # \[[1,2,3]\]
    'escaped_footnote': r'\\?\[\[\^(\d+)\]\]',               # \[[^1]\]
    'escaped_linked': r'\\?\[\[(\d+)\]\(([^)]+)\)\]',        # \[[1](URL)\]
    
    # 標準形式
    'standard_single': r'\[(\d+)\]',                         # [1]
    'standard_multiple': r'\[(\d+(?:[,\s]+\d+)*)\]',         # [1,2,3]
    'standard_range': r'\[(\d+)[-–](\d+)\]',                 # [1-5]
    'standard_footnote': r'\[\^(\d+)\]',                     # [^1]
    'standard_linked': r'\[(\d+)\]\(([^)]+)\)',              # [1](URL)
}
```

#### 統一出力形式
```
すべての引用は以下の統一フォーマットに変換：
- 単一引用: [1]
- 複数引用: [1], [2], [3] （常に個別形式、カンマ+スペース区切り）
- 脚注統一: [^1] → [1] （^記号除去）
- URL分離: [1](URL) → [1] + リンク表生成
```

## コマンドライン仕様

### 基本コマンド

#### 1. 軽量マッピング作成
```bash
# 引用番号 → citation_key マッピングを作成
PYTHONPATH=code/py uv run python code/py/main.py create-citation-mapping \
    --input paper.md \
    --references references.bib
```

#### 2. AI用統合ファイル生成（核心機能）
```bash
# AIが理解できる統合ファイルを生成
PYTHONPATH=code/py uv run python code/py/main.py generate-ai-format \
    --input paper.md \
    --references references.bib \
    --output paper_for_ai.md
```

#### 3. 引用情報解決
```bash
# 特定の引用番号の詳細情報を取得
PYTHONPATH=code/py uv run python code/py/main.py resolve-citation \
    --paper paper.md \
    --citation-number 1
```

#### 4. 統合処理
```bash
# マッピング作成 + AI形式生成を一括実行
PYTHONPATH=code/py uv run python code/py/main.py parse-citations \
    --input paper.md \
    --references references.bib \
    --generate-ai-format \
    --output-dir ./ai_ready/
```

### 統合ワークフローへの組み込み
```bash
# run-integratedに自動組み込み
PYTHONPATH=code/py uv run python code/py/main.py run-integrated \
    --enable-ai-citation-support
```

## 設定仕様

### 設定ファイル
```yaml
# config/ai_citation_parser.yaml
ai_citation_parser:
  # マッピング設定
  mapping:
    auto_create: true                    # 自動マッピング作成
    update_yaml_header: true             # YAMLヘッダー自動更新
    backup_original: true                # 元ファイルバックアップ
    
  # AI統合ファイル生成設定
  ai_format:
    enable_generation: true              # AI形式生成有効化
    include_context: true                # 文脈情報含める
    reference_table_style: "enhanced"    # enhanced | simple
    output_suffix: "_for_ai"             # 出力ファイル接尾辞
    
  # 引用形式統一設定  
  unified_format:
    output_format: "individual"          # individual | grouped
    separator: ", "                      # 区切り文字
    expand_ranges: true                  # 範囲展開
    remove_footnote_symbols: true        # 脚注記号除去
    
  # 動的解決設定
  resolution:
    cache_results: true                  # 解決結果キャッシュ
    context_window: 50                   # 文脈抽出文字数
    relevance_scoring: true              # 関連度スコア算出
```

## データ構造

### CitationMapping
```python
@dataclass
class CitationMapping:
    """軽量引用マッピング情報"""
    references_file: str                 # references.bibファイルパス
    index_map: Dict[int, str]           # 引用番号 → citation_key
    last_updated: datetime              # 最終更新時刻
    mapping_version: str                # マッピングバージョン
    total_citations: int                # 総引用数
```

### CitationInfo
```python
@dataclass  
class CitationInfo:
    """完全な引用文献情報"""
    number: int                         # 引用番号
    citation_key: str                   # BibTeX citation_key
    title: str                          # 論文タイトル
    authors: str                        # 著者情報
    year: int                           # 発行年
    journal: str                        # ジャーナル名
    volume: str                         # 巻号情報
    pages: str                          # ページ情報
    doi: str                            # DOI
    context: str                        # 引用文脈
    relevance_score: float              # 関連度スコア
    full_bibtex: str                    # 完全BibTeXエントリ
```

### AIReadableDocument
```python
@dataclass
class AIReadableDocument:
    """AI理解用統合文書"""
    original_file: str                  # 元ファイル
    references_file: str                # references.bibファイル
    citation_table: str                 # Citation Reference Table
    paper_content: str                  # 論文内容
    generation_timestamp: datetime     # 生成時刻
    total_citations: int                # 総引用数
    ai_optimization_level: str          # AI最適化レベル
```

## テスト仕様

### 機能テスト

#### 1. マッピング作成テスト
```python
def test_citation_mapping_creation():
    """軽量マッピング作成のテスト"""
    markdown_file = "test_paper.md"
    references_bib = "test_references.bib"
    
    mapping = citation_engine.create_citation_mapping(markdown_file, references_bib)
    
    assert mapping.index_map[1] == "smith2023test"
    assert mapping.index_map[2] == "jones2022study"
    assert mapping.total_citations == 3
    assert mapping.references_file == references_bib
```

#### 2. AI統合ファイル生成テスト
```python
def test_ai_readable_file_generation():
    """AI理解用ファイル生成のテスト"""
    input_file = "test_paper.md"
    output_file = ai_generator.generate_ai_readable_file(input_file, "references.bib")
    
    with open(output_file, 'r') as f:
        content = f.read()
    
    # Citation Reference Table存在確認
    assert "📚 Citation Reference Table" in content
    assert "[1] → **Smith, J." in content
    
    # Paper Content存在確認  
    assert "📄 Paper Content" in content
    assert "cancer cells [1],[2],[3]" in content
```

#### 3. 動的解決テスト
```python
def test_citation_resolution():
    """引用情報動的解決のテスト"""
    citation_info = resolver.resolve_citation(1, "test_paper.md")
    
    assert citation_info.number == 1
    assert citation_info.citation_key == "smith2023test"
    assert citation_info.title == "Novel Method for Cancer Analysis"
    assert citation_info.authors == "Smith, J. et al."
    assert citation_info.year == 2023
```

### 統合テスト

#### AI理解度評価テスト
```python
def test_ai_understanding_evaluation():
    """生成されたファイルでAIが適切に引用を理解できるかテスト"""
    
    # AI用ファイル生成
    ai_file = ai_generator.generate_ai_readable_file("paper.md", "references.bib")
    
    # AI理解度シミュレーション
    understanding_score = evaluate_ai_understanding(ai_file)
    
    assert understanding_score >= 0.95  # 95%以上の理解度を要求
```

## 実装ロードマップ

### Phase 1: 軽量マッピング機能（2週間）
1. CitationMappingEngineクラス実装
2. YAMLヘッダー拡張機能
3. 基本テスト作成・実行

### Phase 2: AI統合ファイル生成機能（3週間）
1. AIAssistantFileGeneratorクラス実装
2. Citation Reference Table生成ロジック
3. AI最適化フォーマット設計・実装

### Phase 3: 動的解決機能（2週間）
1. CitationResolverクラス実装
2. リアルタイム情報取得機能
3. 文脈抽出機能

### Phase 4: 統合・最適化（2週間）
1. 既存ワークフローへの統合
2. パフォーマンス最適化
3. 包括的テスト実行

### Phase 5: リリース準備（1週間）
1. ドキュメント更新
2. 設定システム整備
3. 最終検証

## 期待される効果

### AIアシスタント利用の革命的改善
- **完全な引用理解**: AIが[1],[2],[3]の意味を完全把握
- **適切な論文生成**: 引用情報を理解した高品質な論文作成
- **作業効率向上**: 人間がAIに論文執筆依頼時の準備時間短縮

### データ品質向上
- **軽量設計**: YAMLヘッダーは最小限の情報のみ
- **データ一意性**: references.bibが唯一の情報源
- **リアルタイム更新**: 常に最新の引用情報を提供

### ワークフロー改善
- **シンプルなコマンド**: 1つのコマンドでAI用ファイル生成
- **統合実行**: run-integratedに自動組み込み
- **柔軟な設定**: 用途に応じたカスタマイズ可能

## 使用例

### 基本的な使用フロー

```bash
# 1. 論文執筆完了後、AI用ファイル生成
PYTHONPATH=code/py uv run python code/py/main.py generate-ai-format \
    --input "pancreatic_cancer_analysis.md" \
    --references "references.bib" \
    --output "pancreatic_cancer_for_ai.md"

# 2. 生成されたファイルをAIアシスタントに提供
# → AIが引用文献を完全理解
# → 高品質な論文執筆・要約・分析が可能

# 3. 統合ワークフローでの自動実行
PYTHONPATH=code/py uv run python code/py/main.py run-integrated \
    --enable-ai-citation-support
```

### 出力例比較

#### Before（従来）
```
# AIに提供するファイル
Recent studies suggest that KRTs are mediators [1],[2],[3].

# AIの反応
AI: 「[1],[2],[3]が何の文献か分からないため、適切な引用付き文章を作成できません」
```

#### After（v4.0）
```
# AIに提供するファイル（自動生成）
## 📚 Citation Reference Table
[1] → Smith, J. et al. (2023). "Novel Method for Cancer Analysis". Cancer Research, 83(12), 1234-1245.
[2] → Jones, M. & Wilson, K. (2022). "Advanced Biomarker Techniques". Nature Medicine, 28, 567-578.
[3] → Brown, A. (2021). "Differential Diagnosis in Oncology". Cell, 185, 890-905.

## 📄 Paper Content
Recent studies suggest that KRTs are mediators [1],[2],[3].

# AIの反応
AI: 「Smith et al.の癌細胞解析手法[1]、Jonesのバイオマーカー技術[2]、Brownの診断手法[3]を踏まえて、
     適切な引用付きの論文を執筆いたします」
```

---

**v4.0の革新ポイント：AIが引用文献を完全理解し、人間のAI論文執筆支援が飛躍的に向上**