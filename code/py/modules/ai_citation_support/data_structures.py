"""
AIç†è§£æ”¯æ´å¼•ç”¨æ–‡çŒ®çµ±åˆç”¨ãƒ‡ãƒ¼ã‚¿æ§‹é€  v4.0

æ–°æ©Ÿèƒ½ã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ã¨å‹å®šç¾©ã‚’æä¾›ã—ã¾ã™ã€‚
"""

from dataclasses import dataclass, field
from datetime import datetime
from typing import Dict, List, Optional, Any
from pathlib import Path


@dataclass
class CitationMapping:
    """è»½é‡å¼•ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±"""
    references_file: str                 # references.bibãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    index_map: Dict[int, str]           # å¼•ç”¨ç•ªå· â†’ citation_key
    last_updated: datetime              # æœ€çµ‚æ›´æ–°æ™‚åˆ»
    mapping_version: str                # ãƒãƒƒãƒ”ãƒ³ã‚°ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    total_citations: int                # ç·å¼•ç”¨æ•°
    
    def to_yaml_dict(self) -> Dict[str, Any]:
        """YAMLãƒ˜ãƒƒãƒ€ãƒ¼ç”¨è¾æ›¸ã«å¤‰æ›"""
        return {
            'references_file': self.references_file,
            'index_map': self.index_map,
            'last_updated': self.last_updated.isoformat(),
            'mapping_version': self.mapping_version,
            'total_citations': self.total_citations
        }
    
    @classmethod
    def from_yaml_dict(cls, data: Dict[str, Any]) -> 'CitationMapping':
        """YAMLè¾æ›¸ã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ"""
        return cls(
            references_file=data['references_file'],
            index_map=data['index_map'],
            last_updated=datetime.fromisoformat(data['last_updated']),
            mapping_version=data['mapping_version'],
            total_citations=data['total_citations']
        )


@dataclass
class CitationInfo:
    """å®Œå…¨ãªå¼•ç”¨æ–‡çŒ®æƒ…å ±"""
    number: int                         # å¼•ç”¨ç•ªå·
    citation_key: str                   # BibTeX citation_key
    title: str                          # è«–æ–‡ã‚¿ã‚¤ãƒˆãƒ«
    authors: str                        # è‘—è€…æƒ…å ±
    year: int                           # ç™ºè¡Œå¹´
    journal: str                        # ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å
    volume: str                         # å·»å·æƒ…å ±
    pages: str                          # ãƒšãƒ¼ã‚¸æƒ…å ±
    doi: str                            # DOI
    context: str = ""                   # å¼•ç”¨æ–‡è„ˆ
    relevance_score: float = 0.0        # é–¢é€£åº¦ã‚¹ã‚³ã‚¢
    full_bibtex: str = ""               # å®Œå…¨BibTeXã‚¨ãƒ³ãƒˆãƒª
    
    def to_reference_line(self) -> str:
        """AIç†è§£ç”¨Reference Tableè¡Œã‚’ç”Ÿæˆ"""
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: [1] â†’ **è‘—è€…** (å¹´). *ã‚¿ã‚¤ãƒˆãƒ«*. **ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«**, å·»(å·), ãƒšãƒ¼ã‚¸. DOI: xxx
        volume_info = f"{self.volume}" if self.volume else ""
        pages_info = f", {self.pages}" if self.pages else ""
        volume_pages = f", {volume_info}{pages_info}" if volume_info or pages_info else ""
        
        doi_info = f" DOI: {self.doi}" if self.doi else ""
        
        reference_line = (
            f"[{self.number}] â†’ **{self.authors}** ({self.year}). "
            f"*{self.title}*. **{self.journal}**{volume_pages}.{doi_info}"
        )
        
        if self.context:
            reference_line += f"\n    â””â”€ **Context**: {self.context}"
        
        return reference_line


@dataclass
class AIReadableDocument:
    """AIç†è§£ç”¨çµ±åˆæ–‡æ›¸"""
    original_file: str                  # å…ƒãƒ•ã‚¡ã‚¤ãƒ«
    references_file: str                # references.bibãƒ•ã‚¡ã‚¤ãƒ«
    citation_table: str                 # Citation Reference Table
    paper_content: str                  # è«–æ–‡å†…å®¹
    generation_timestamp: datetime     # ç”Ÿæˆæ™‚åˆ»
    total_citations: int                # ç·å¼•ç”¨æ•°
    ai_optimization_level: str = "enhanced"  # AIæœ€é©åŒ–ãƒ¬ãƒ™ãƒ«
    
    def to_markdown(self) -> str:
        """AIç†è§£ç”¨Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ"""
        timestamp_str = self.generation_timestamp.strftime("%Y-%m-%d %H:%M:%S")
        
        content = f"""# {Path(self.original_file).stem}
*Generated by ObsClippingsManager v4.0 for AI Assistant*

## ğŸ“š Citation Reference Table
**AI Assistant Reference Guide: This table provides complete citation information for all numbered references in the paper.**

{self.citation_table}

---

## ğŸ“„ Paper Content

{self.paper_content}

---
*End of AI Assistant Document*
*Original file: {Path(self.original_file).name} | References: {Path(self.references_file).name} | Generated: {timestamp_str}*
"""
        return content


@dataclass
class MappingStatistics:
    """ãƒãƒƒãƒ”ãƒ³ã‚°çµ±è¨ˆæƒ…å ±"""
    created_mappings: int = 0
    updated_mappings: int = 0
    failed_mappings: int = 0
    total_citations_mapped: int = 0
    processing_time: float = 0.0
    
    def __str__(self) -> str:
        return (
            f"Mapping Statistics: "
            f"Created: {self.created_mappings}, "
            f"Updated: {self.updated_mappings}, "
            f"Failed: {self.failed_mappings}, "
            f"Citations: {self.total_citations_mapped}, "
            f"Time: {self.processing_time:.2f}s"
        )


@dataclass
class AIGenerationResult:
    """AIç”¨ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆçµæœ"""
    success: bool
    output_file: str = ""
    statistics: Optional[MappingStatistics] = None
    error_message: str = ""
    warnings: List[str] = field(default_factory=list)
    
    def __str__(self) -> str:
        if self.success:
            return f"âœ… AI file generated: {self.output_file}"
        else:
            return f"âŒ Generation failed: {self.error_message}" 